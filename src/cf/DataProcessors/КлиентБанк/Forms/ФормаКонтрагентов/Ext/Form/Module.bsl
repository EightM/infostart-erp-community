&НаСервере
Процедура СоздатьСервер()
	Если Объект.Организация.Пустая() Тогда
		Сообщить("Не выбрана организация", СтатусСообщения.Внимание);
		Возврат;
	КонецЕсли;
	
	ОбъектДерева=РеквизитФормыВЗначение("Объект");
	
	МассивСтрок=Новый Массив;
	Для Каждого Строка Из ДеревоКонтрагентов.ПолучитьЭлементы() Цикл
		Если Строка.Пометка Тогда
			Если НЕ ОбъектДерева.СоздатьКонтрагента(Строка,ФлажокОткрытияФормКотранетов).Пустая() Тогда
				МассивСтрок.Добавить(Строка);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого Строка ИЗ МассивСтрок Цикл
		ДеревоКонтрагентов.ПолучитьЭлементы().Удалить(Строка);
	КонецЦикла;
	
	Если Не ОткрытаИзПлатежногоДокумента Тогда
		ЭтотОбъект.ПолучитьФорму("Форма").КоманднаяПанельДокументыДляИмпортаОбновить(неопределено);
		УстановитьПометки();
	КонецЕсли;
	
	Если ДеревоКонтрагентов.ПолучитьЭлементы().Количество() = 0 Тогда
		Закрыть();
	КонецЕсли;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ЭЛЕМЕНТОВ ФОРМЫ

&НаКлиенте
Процедура ВыполнитьДействие(Команда)
	Если Команда.Имя="УстановитьВсе" Тогда
		УстановитьПометки();
		
	ИначеЕсли Команда.Имя="СнятьВсеПометки" Тогда
		Для Каждого Строка Из ДеревоКонтрагентов.ПолучитьЭлементы() Цикл
			Строка.Пометка=Ложь;
			Если Строка.ПолучитьЭлементы().количество()>0 Тогда
				Для Каждого ВнСтрока Из Строка.ПолучитьЭлементы() Цикл
					ВнСтрока.Пометка=Ложь;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
		
	ИначеЕсли Команда.Имя="Создать" Тогда
		СоздатьСервер();
	КонецЕсли;	
КонецПроцедуры

&НаСервере
Процедура УстановитьПометки()
	Для Каждого Строка Из ДеревоКонтрагентов.ПолучитьЭлементы() Цикл
		ПроверкаРеквизита(Строка);
		Для Каждого ВнСтрока Из Строка.ПолучитьЭлементы() Цикл
			Если ВнСтрока.ПолучитьЭлементы().Количество()>0 Тогда
				ПроверкаРеквизита(ВнСтрока);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ПроверкаРеквизита(Строка)
	Если ЗначениеЗаполнено(Строка.Реквизит) Тогда
		Строка.Пометка=Ложь;
	Иначе
		Строка.Пометка=Истина;
	КонецЕсли;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура СформироватьИЗагрузитьДеревоПоТаблицеЗначений(РеквизитыКонтрагента) Экспорт

	Дерево=Новый ДеревоЗначений;
    Дерево.Колонки.Добавить("Представление");
    Дерево.Колонки.Добавить("Значение");
    Дерево.Колонки.Добавить("Реквизит");
    Дерево.Колонки.Добавить("Пометка");
	
	НовыйЭлемент0 = Дерево.Строки.Добавить();
	НовыйЭлемент0.Представление = РеквизитыКонтрагента[0].Значение;

	Для Счет1=0 по РеквизитыКонтрагента.Количество()-1 Цикл
		
		Если РеквизитыКонтрагента[Счет1].Представление = "Р/счет" Тогда
			НовыйЭлемент1 = Дерево.Строки[0].Строки.Добавить();
			НовыйЭлемент1.Представление = РеквизитыКонтрагента[Счет1].Представление;
			НовыйЭлемент1.Значение 		= РеквизитыКонтрагента[Счет1].Значение;
			НовыйЭлемент1.Реквизит 		= РеквизитыКонтрагента[Счет1].Реквизит;
			Для Счет2=Счет1+1 по РеквизитыКонтрагента.Количество()-1 Цикл
				Если РеквизитыКонтрагента[Счет2].Представление = "Договор" Тогда
					НовыйЭлемент1 = Дерево.Строки[0].Строки.Добавить();
					НовыйЭлемент1.Представление = РеквизитыКонтрагента[Счет2].Представление;
					НовыйЭлемент1.Значение 		= РеквизитыКонтрагента[Счет2].Значение;
					НовыйЭлемент1.Реквизит 		= РеквизитыКонтрагента[Счет2].Реквизит;
					
					Для Счет3=Счет2+1 по РеквизитыКонтрагента.Количество()-1 Цикл
						НовыйЭлемент2 = Дерево.Строки[0].Строки[Счет1+1].Строки.Добавить();
						НовыйЭлемент2.Представление = РеквизитыКонтрагента[Счет3].Представление;
						НовыйЭлемент2.Значение 		= РеквизитыКонтрагента[Счет3].Значение;
						НовыйЭлемент2.Реквизит 		= РеквизитыКонтрагента[Счет3].Реквизит;
					КонецЦикла;	
					Прервать;
				Иначе
					НовыйЭлемент2 = Дерево.Строки[0].Строки[Счет1].Строки.Добавить();
					НовыйЭлемент2.Представление = РеквизитыКонтрагента[Счет2].Представление;
					НовыйЭлемент2.Значение 		= РеквизитыКонтрагента[Счет2].Значение;
					НовыйЭлемент2.Реквизит 		= РеквизитыКонтрагента[Счет2].Реквизит;
				КонецЕсли
			КонецЦикла;	
			Прервать;
		Иначе
			НовыйЭлемент1 = Дерево.Строки[0].Строки.Добавить();
			НовыйЭлемент1.Представление = РеквизитыКонтрагента[Счет1].Представление;
			НовыйЭлемент1.Значение 		= РеквизитыКонтрагента[Счет1].Значение;
			НовыйЭлемент1.Реквизит 		= РеквизитыКонтрагента[Счет1].Реквизит;
		КонецЕсли;
		
	КонецЦикла;	
	                                      
	ОткрытаИзПлатежногоДокумента=истина;
	Элементы.ДеревоКонтрагентовЗначение=Дерево;
	Элементы.ДеревоКонтрагентов.НачальноеОтображениеДерева=НачальноеОтображениеДерева.РаскрыватьВерхнийУровень;

КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Объект.Организация=ЭтаФорма.ВладелецФормы.Объект.Организация;
	Элементы.ДеревоКонтрагентовПометка.Заголовок="Пометка";
	Элементы.ДеревоКонтрагентов.ТолькоПросмотр=Ложь;
	Если Не ОткрытаИзПлатежногоДокумента Тогда
		Для каждого СтрокаКоллекции Из ЭтаФорма.ВладелецФормы.ТаблицаКонтрагентов.ПолучитьЭлементы() Цикл
			НоваяСтрока=ДеревоКонтрагентов.ПолучитьЭлементы().Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрокаКоллекции);
			Если СтрокаКоллекции.ПолучитьЭлементы().Количество()>0 Тогда
				Для каждого СтрокаКоллекции1 Из СтрокаКоллекции.ПолучитьЭлементы() Цикл
					НоваяСтрока2=НоваяСтрока.ПолучитьЭлементы().Добавить();
					ЗаполнитьЗначенияСвойств(НоваяСтрока2,СтрокаКоллекции1);
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	УстановитьПометки();
КонецПроцедуры
